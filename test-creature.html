<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”Ÿç‰©ç³»ç»Ÿæµ‹è¯•</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
    .test-case { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
    .pass { background: #e8f5e9; border-color: #4caf50; }
    .fail { background: #ffebee; border-color: #f44336; }
    h2 { margin: 0 0 10px 0; }
    .detail { font-size: 14px; color: #666; margin-top: 8px; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    #log { background: #f5f5f5; padding: 10px; margin-top: 20px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>ğŸ§ª ç”Ÿç‰©ç³»ç»Ÿæµ‹è¯•</h1>
  
  <div id="tests"></div>
  
  <div>
    <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
  </div>
  
  <div id="log"></div>
  
  <script type="module">
    import { CREATURES, getCreatureById, RACE_NAMES, SYNERGY_LEVELS } from './src/data/Creatures.ts';
    import { CreatureManager } from './src/utils/CreatureManager.ts';
    import { DataManager } from './src/utils/DataManager.ts';
    
    // åˆå§‹åŒ–
    DataManager.init();
    
    window.clearLog = () => {
      document.getElementById('log').innerHTML = '';
    };
    
    function log(msg, type = 'info') {
      const logEl = document.getElementById('log');
      const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
      logEl.innerHTML += `<div style="color:${color}">${new Date().toLocaleTimeString()}: ${msg}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
    }
    
    function createTest(name, testFn) {
      return { name, testFn };
    }
    
    async function runTest(test) {
      const testsEl = document.getElementById('tests');
      const div = document.createElement('div');
      div.className = 'test-case';
      div.innerHTML = `<h2>${test.name}</h2><div class="status">è¿è¡Œä¸­...</div>`;
      testsEl.appendChild(div);
      
      try {
        const result = await test.testFn();
        div.classList.add(result.pass ? 'pass' : 'fail');
        div.querySelector('.status').innerHTML = result.pass ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
        if (result.detail) {
          div.innerHTML += `<div class="detail">${result.detail}</div>`;
        }
        log(`${test.name}: ${result.pass ? 'PASS' : 'FAIL'}`, result.pass ? 'success' : 'error');
      } catch (e) {
        div.classList.add('fail');
        div.querySelector('.status').innerHTML = 'âŒ é”™è¯¯';
        div.innerHTML += `<div class="detail" style="color:red">${e.message}</div>`;
        log(`${test.name}: ERROR - ${e.message}`, 'error');
      }
    }
    
    const tests = [
      createTest('1. ç”Ÿç‰©æ•°æ®åŠ è½½', () => {
        const count = CREATURES.length;
        return {
          pass: count === 35,
          detail: `ç”Ÿç‰©æ•°é‡: ${count} (æœŸæœ›: 35)`
        };
      }),
      
      createTest('2. ç”Ÿç‰©æŸ¥è¯¢', () => {
        const pikeman = getCreatureById('pikeman');
        return {
          pass: pikeman && pikeman.name === 'æªå…µ',
          detail: pikeman ? `æ‰¾åˆ°: ${pikeman.name}` : 'æœªæ‰¾åˆ°æªå…µ'
        };
      }),
      
      createTest('3. CreatureManager åˆå§‹åŒ–', () => {
        const cm = new CreatureManager();
        return {
          pass: true,
          detail: `é˜Ÿä¼ä¸Šé™: ${cm.getTeamSize()}, å½“å‰æ•°é‡: ${cm.getTeam().length}`
        };
      }),
      
      createTest('4. æ·»åŠ æ–°ç”Ÿç‰©', () => {
        const cm = new CreatureManager();
        cm.clear();  // æ¸…ç©ºé˜Ÿä¼
        const result = cm.addCreature('pikeman');
        return {
          pass: result.success && cm.getTeam().length === 1,
          detail: `ç»“æœ: ${result.message}, é˜Ÿä¼æ•°é‡: ${cm.getTeam().length}`
        };
      }),
      
      createTest('5. ç”Ÿç‰©å‡æ˜Ÿ', () => {
        const cm = new CreatureManager();
        cm.clear();
        cm.addCreature('pikeman');  // æ·»åŠ 1æ˜Ÿ
        const result = cm.addCreature('pikeman');  // å†æ¬¡æ·»åŠ åº”è¯¥å‡æ˜Ÿ
        return {
          pass: result.success && result.upgraded && result.newStar === 2,
          detail: `ç»“æœ: ${result.message}, æ–°æ˜Ÿçº§: ${result.newStar}`
        };
      }),
      
      createTest('6. æ»¡æ˜Ÿç”Ÿç‰©ä¸å†å‡ºç°', () => {
        const cm = new CreatureManager();
        cm.clear();
        cm.addCreature('pikeman');
        cm.addCreature('pikeman');
        cm.addCreature('pikeman');  // 3æ˜Ÿæ»¡çº§
        const available = cm.getAvailableCreatures();
        const hasPikeman = available.some(c => c.id === 'pikeman');
        return {
          pass: !hasPikeman,
          detail: `å¯ç”¨ç”Ÿç‰©æ± æ˜¯å¦åŒ…å«æªå…µ: ${hasPikeman}`
        };
      }),
      
      createTest('7. ç”Ÿæˆè‚‰é¸½é€‰é¡¹', () => {
        const cm = new CreatureManager();
        cm.clear();
        const choices = cm.generateChoices();
        return {
          pass: choices.length >= 1 && choices.length <= 3,
          detail: `ç”Ÿæˆé€‰é¡¹æ•°é‡: ${choices.length}, ç±»å‹: ${choices.map(c => c.type).join(', ')}`
        };
      }),
      
      createTest('8. ç¾ç»Šè®¡ç®—', () => {
        const cm = new CreatureManager();
        cm.clear();
        cm.addCreature('pikeman');   // åŸå ¡
        cm.addCreature('archer');    // åŸå ¡
        const synergies = cm.calculateSynergies();
        const castleSynergy = synergies.find(s => s.race === 'castle');
        return {
          pass: castleSynergy && castleSynergy.level >= 1,
          detail: castleSynergy ? `åŸå ¡ç¾ç»Š: ç­‰çº§${castleSynergy.level}, æ•°é‡${castleSynergy.count}` : 'æ— ç¾ç»Š'
        };
      }),
      
      createTest('9. å±æ€§è®¡ç®—', () => {
        const cm = new CreatureManager();
        cm.clear();
        cm.addCreature('pikeman');
        const creature = cm.getTeam()[0];
        const stats = cm.getCreatureStats(creature);
        return {
          pass: stats && stats.hp > 0 && stats.attack > 0,
          detail: stats ? `HP: ${stats.hp}, ATK: ${stats.attack}, DEF: ${stats.defense}` : 'æ— æ³•è®¡ç®—å±æ€§'
        };
      }),
      
      createTest('10. é˜Ÿä¼æ»¡åæ— æ³•æ·»åŠ ', () => {
        const cm = new CreatureManager();
        cm.clear();
        // æ·»åŠ 5ä¸ªä¸åŒç”Ÿç‰©
        cm.addCreature('pikeman');
        cm.addCreature('archer');
        cm.addCreature('griffin');
        cm.addCreature('swordsman');
        cm.addCreature('monk');
        const result = cm.addCreature('knight');  // ç¬¬6ä¸ªåº”è¯¥å¤±è´¥
        return {
          pass: !result.success && result.message === 'é˜Ÿä¼å·²æ»¡',
          detail: `ç»“æœ: ${result.message}`
        };
      })
    ];
    
    window.runAllTests = async () => {
      document.getElementById('tests').innerHTML = '';
      log('=== å¼€å§‹æµ‹è¯• ===');
      for (const test of tests) {
        await runTest(test);
      }
      log('=== æµ‹è¯•å®Œæˆ ===');
    };
    
    // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œ
    window.runAllTests();
  </script>
</body>
</html>
